type: update
id: postgres-master-slave-auto-cluster
baseUrl: https://raw.githubusercontent.com/sych74/postgresql-replication/master
logo: /images/postgres-70x70.png
name: PostgreSQL Master-Slave Auto-Cluster

targetNodes: none
nodeGroupAlias:
  ${settings.nodeGroup}: sqldb
  
onInstall: init

actions:
  init:
    - env.control.AddContainerEnvVars[sqldb]:
        vars: {"KEY_PASS":"${fn.password}"}
    - forEach(nodes.sqldb):
        - if (${@i.id} == ${nodes.sqldb.master.id}): 
            setGlobals:
              mId: ${@i.id}
        - else: 
            setGlobals:
              sId: ${@i.id}
              sIP: ${@i.address}          
    - cmd [${globals.mId}]: |-
        jcm initMaster ${globals.sIP} &>> /var/log/run.log
    - cmd [${globals.sId}]: |-
        jcm setPswd ${globals.pswd} true
        jcm initSlave &>> /var/log/run.log

startPage: ${nodes.sqldb.master.url}
success: |
  **Admin Panel**: [${nodes.sqldb.master.url}](${nodes.sqldb.master.url})  
  **User**: webadmin  
  **Password**: ${nodes.sqldb.password}  

  * [Database Replication with PostgreSQL](https://docs.jelastic.com/postgresql-database-replication/)
  * [Remote Access to PostgreSQL](https://docs.jelastic.com/remote-access-postgres/)
  * [Import and Export Dump to PostgreSQL](https://docs.jelastic.com/dump-postgres/)

  
